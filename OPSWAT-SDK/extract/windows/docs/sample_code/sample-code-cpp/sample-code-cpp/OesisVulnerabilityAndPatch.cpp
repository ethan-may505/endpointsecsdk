#include "OesisVulnerabilityAndPatch.h"

#include <iostream>
#include <sstream>

using namespace std;

OesisVulnerabilityAndPatch::OesisVulnerabilityAndPatch()
{
    this->oesis = OesisFramework::instance();
}

OesisVulnerabilityAndPatch::OesisVulnerabilityAndPatch(wstring downloadToken){}

int OesisVulnerabilityAndPatch::LoadPatchDatabase(wstring& json_out)
{
    wstring json_in = L"";
    map<string, string> param = {
        {"method", to_string(WA_VMOD_PATCH_LOAD_DATABASE)},
        {"dat_input_source_file", "patch.dat"}
    };
    int rc = oesis->Invoke(param, json_out);
    return rc;
}

int OesisVulnerabilityAndPatch::ConsumeOfflineVmodDatabase(wstring& json_out)
{
    wstring json_in = L"";
    map<string, string> param = {
        {"method", to_string(WAAPI_MID_CONSUME_OFFLINE_VMOD_DATABASE)},
        {"dat_input_source_file", "vmod.dat"}
    };
    int rc = oesis->Invoke(param, json_out);
    return rc;
}

int OesisVulnerabilityAndPatch::GetLatestInstaller(wstring& json_out, int download, string location)
{
    wstring json_in = L"";
    map<string, string> param = {
        {"method", to_string(WA_VMOD_PATCH_GET_LATEST_INSTALLER)},
        {"signature", to_string(this->signature_id)}
    };
    if (download > 0)
    {
        param["download"] = to_string(download);
        param["path"] = location;
    }
    int rc = oesis->Invoke(param, json_out);
    return rc;
}

json OesisVulnerabilityAndPatch::GetProductPatchLevel()
{
    wstring json_out;
    json jsonOut;
    wstring json_in = L"";
    map<string, string> param = {
        {"method", to_string(WAAPI_MID_GET_PRODUCT_PATCH_LEVEL)},
        {"signature", to_string(this->signature_id)}
    };
    int rc = oesis->Invoke(param, json_out);
    OesisUtils::GetJsonValues(jsonOut, rc, json_out, { "is_current", "details" });
    return jsonOut;
}
json OesisVulnerabilityAndPatch::GetProductVulnerability() 
{
    wstring json_out;
    json jsonOut;
    wstring json_in = L"";
    map<string, string> param = {
        {"method", to_string(WAAPI_MID_GET_PRODUCT_VULNERABILITY)},
        {"signature", to_string(this->signature_id)}
    };
    int rc = oesis->Invoke(param, json_out);
    OesisUtils::GetJsonValues(jsonOut, rc, json_out, { "has_vulnerability", "has_kb", "severity", "cves", "msbs", "kbs" });
    return jsonOut;
}

json OesisVulnerabilityAndPatch::GetRemediations()
{
    wstring json_out;
    json jsonOut;
    wstring json_in = L"";
    map<string, string> param = {
        {"method", to_string(WAAPI_MID_GET_REMEDIATIONS)},
        {"signature", to_string(this->signature_id)}
    };
    int rc = oesis->Invoke(param, json_out);
    OesisUtils::GetJsonValues(jsonOut, rc, json_out, { "remediation_link" });
    return jsonOut;
}

json OesisVulnerabilityAndPatch::GetLatestInstaller(int download, string location)
{
    wstring json_out;
    json jsonOut;
    wstring json_in = L"";
    map<string, string> param = {
        {"method", to_string(WA_VMOD_PATCH_GET_LATEST_INSTALLER)},
        {"signature", to_string(this->signature_id)}
    };
    if (download > 0)
    {
        param["download"] = to_string(download);
        param["path"] = location;
    }
    int rc = oesis->Invoke(param, json_out);
    OesisUtils::GetJsonValues(jsonOut, rc, json_out, { "type_id", "patch_id", "index", "eula", "release_note","release_date",
                                                    "url", "minimum_version", "language", "architecture", "file_type", "path" });
    return jsonOut;
}

json OesisVulnerabilityAndPatch::InstallFromFile(string path, int force_close){
    wstring json_out;
    json jsonOut;
    wstring json_in = L"";
    map<string, string> param = {
        {"method", to_string(WA_VMOD_PATCH_INSTALL_FROM_FILES)},
        {"signature", to_string(this->signature_id)},
        {"path", path}
    };
    if(force_close == 1)
    {
        param["force_close"] = to_string(1);
    }
    int rc = oesis->Invoke(param, json_out);
    OesisUtils::GetJsonValues(jsonOut, rc, json_out, {});
    return jsonOut;
}

OesisVulnerabilityAndPatch::~OesisVulnerabilityAndPatch(){}
