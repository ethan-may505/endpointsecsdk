#include "OesisAntimalwareProduct.h"

OesisAntimalwareProduct::OesisAntimalwareProduct()
{
    this->oesis = OesisFramework::instance();
}

OesisAntimalwareProduct::~OesisAntimalwareProduct(){}

json OesisAntimalwareProduct::GetRealTimeProtectionState()
{
    wstring json_out;
    json jsonOut;
    wstring json_in = L"";
    map<string, string> param = {
        {"method", to_string(WAAPI_MID_GET_RTP_STATE)},
        {"signature", to_string(this->signature_id)}
    };
    int rc = oesis->Invoke(param, json_out);
    OesisUtils::GetJsonValues(jsonOut, rc, json_out, { "details", "enabled" });
    return jsonOut;
}

json OesisAntimalwareProduct::GetDefinitionState()
{
    wstring json_out;
    json jsonOut;
    wstring json_in = L"";
    map<string, string> param = {
        {"method", to_string(WAAPI_MID_GET_DEF_STATE)},
        {"signature", to_string(this->signature_id)}
    };
    int rc = oesis->Invoke(param, json_out);
    OesisUtils::GetJsonValues(jsonOut, rc, json_out, { "definitions", "is_recent" });
    return jsonOut;
}

json OesisAntimalwareProduct::GetLastScanTime()
{
    wstring json_out;
    json jsonOut;
    wstring json_in = L"";
    map<string, string> param = {
        {"method", to_string(WAAPI_MID_GET_LAST_SCAN_TIME)},
        {"signature", to_string(this->signature_id)},
        {"scan_type", "full" }
    };
    int rc = oesis->Invoke(param, json_out);
    if (WAAPI_SUCCESS(rc))
    {
        string str = OesisUtils::utf8_encode(json_out);
        auto obj = json::parse(str);
        if (OesisUtils::CheckJsonKey(obj, "result") && OesisUtils::CheckJsonKey(obj["result"], "scan_time"))
        {
            jsonOut["last_full_scan"] = obj["result"]["scan_time"];
        }
    }
    param["scan_type"] = "default";
    rc = oesis->Invoke(param, json_out);
    if (WAAPI_SUCCESS(rc))
    {
        string str = OesisUtils::utf8_encode(json_out);
        auto obj = json::parse(str);
        if (OesisUtils::CheckJsonKey(obj, "result") && OesisUtils::CheckJsonKey(obj["result"], "scan_time"))
        {
            jsonOut["last_default_scan"] = obj["result"]["scan_time"];
        }
    }
    return jsonOut;
}

json OesisAntimalwareProduct::GetThreats()
{
    wstring json_out;
    json jsonOut;
    wstring json_in = L"";
    map<string, string> param = {
        {"method", to_string(WAAPI_MID_GET_THREATS)},
        {"signature", to_string(this->signature_id)}
    };
    int rc = oesis->Invoke(param, json_out);
    OesisUtils::GetJsonValues(jsonOut, rc, json_out, { "last_threat_time", "no_threats", "threats" });
    return jsonOut;
}

json OesisAntimalwareProduct::GetScanState()
{
    wstring json_out;
    json jsonOut;
    wstring json_in = L"";
    map<string, string> param = {
        {"method", to_string(WAAPI_MID_GET_SCAN_STATE)},
        {"signature", to_string(this->signature_id)}
    };
    int rc = oesis->Invoke(param, json_out);
    OesisUtils::GetJsonValues(jsonOut, rc, json_out, { "state" });
    return jsonOut;
}
