using Newtonsoft.Json.Linq;
using System;
using System.Collections.Generic;
using System.Text;
using System.Text.Json;
using System.IO;
using System.Reflection;

namespace sample_code_cs
{
    public class OesisVulnerabilityAndPatch : OesisGenericProduct
    {
        private static readonly OesisVulnerabilityAndPatch m_instance = new OesisVulnerabilityAndPatch();

        public OesisVulnerabilityAndPatch(){}

        public static OesisVulnerabilityAndPatch instance
        {
            get
            {
                return m_instance;
            }
        }

        public JObject GetProductPatchLevel()
        {
            string json_in = "";
            Dictionary<string, object> input = new Dictionary<string, object>()
            {
                { "method", 50500 },
                { "signature", this.signatureId }
            };
            OesisUtils.CreateJsonIn(ref json_in, input);
            string json_out;
            JObject result = new JObject();
            int rc = this.oesis.Invoke(json_in, out json_out);
            OesisUtils.GetJsonValues(ref result, rc, json_out, new List<string>{ "is_current", "details" });
            return result;
        }

        public JObject GetProductVulnerability()
        {
            string json_in = "";
            Dictionary<string, object> input = new Dictionary<string, object>()
            {
                { "method", 50505 },    
                { "signature", this.signatureId }
            };
            OesisUtils.CreateJsonIn(ref json_in, input);
            string json_out;
            JObject result = new JObject();
            int rc = this.oesis.Invoke(json_in, out json_out);
            OesisUtils.GetJsonValues(ref result, rc, json_out, 
                                        new List<string> { "has_vulnerability", "has_kb", "severity", "cves", "msbs", "kbs" });
            return result;
        }

        public JObject GetRemediations()
        {
            //string json_in = "{\"input\": { \"method\": 50503, \"signature\": " + this.signatureId + " } }";
            string json_in = "";
            Dictionary<string, object> input = new Dictionary<string, object>()
            {
                { "method", 50503 },
                { "signature", this.signatureId }
            };
            OesisUtils.CreateJsonIn(ref json_in, input);
            string json_out;
            JObject result = new JObject();
            int rc = this.oesis.Invoke(json_in, out json_out);
            OesisUtils.GetJsonValues(ref result, rc, json_out, new List<string> { "remediation_link" });
            return result;
        }

        public JObject GetLatestInstaller()
        {
            //string json_in = "{\"input\" : {\"method\" : 50300, \"signature\" :" + this.signatureId + ", \"download\": 0 }}";
            string json_in = "";
            Dictionary<string, object> input = new Dictionary<string, object>()
            {
                { "method", 50300 },
                { "signature", this.signatureId },
                { "download", 0}
            };
            OesisUtils.CreateJsonIn(ref json_in, input);
            string json_out;
            JObject result = new JObject();
            int rc = this.oesis.Invoke(json_in, out json_out);
            OesisUtils.GetJsonValues(ref result, rc, json_out, new List<string> { "type_id", "patch_id", "index", "eula", "release_note","release_date", 
                                                                "url", "minimum_version", "language", "architecture", "file_type" });
            
            return result;
        }

        public JObject InstallFromFiles(int force_close, string location)
        {
            location = FixPath(location);
            location = FixPath(location);
            if (force_close!=1)
            {
                force_close = 0;
            }
            //string json_in = "{\"input\" : { \"method\" : 50301, \"signature\" :" + this.signatureId + ", \"force_close\" : " + force_close + ", \"path\":" + "\"" + location + "\" }}";
            string json_in = "";
            Dictionary<string, object> input = new Dictionary<string, object>()
            {
                { "method", 50301 },
                { "signature", this.signatureId },
                { "path", location },
                { "force_close", force_close }
            };
            OesisUtils.CreateJsonIn(ref json_in, input);
            string json_out;
            JObject result = new JObject();
            int rc = this.oesis.Invoke(json_in, out json_out);
            OesisUtils.GetJsonValues(ref result, rc, json_out, new List<string> {});
            return result;
        }

        public int ConsumeOfflineVmodDatabase()
        {
            string json_in = "";
            string path = "vmod.dat";
            if (OesisFramework.GetOSType() == OesisFramework.PLATFORM.LINUX || OesisFramework.GetOSType() == OesisFramework.PLATFORM.MAXOS)
                path = Path.Combine(Path.GetDirectoryName(Assembly.GetEntryAssembly().Location), "vmod.dat");
            Dictionary<string, object> input = new Dictionary<string, object>()
            {
                { "method", 50520 },
                { "dat_input_source_file", path}
            };
            OesisUtils.CreateJsonIn(ref json_in, input);
            string json_out;
            int rc = this.oesis.Invoke(json_in, out json_out);
            return rc;
        }

        public int LoadPatchDatabase()
        {
            string json_in = "";
            string path = "patch.dat";
            if (OesisFramework.GetOSType() == OesisFramework.PLATFORM.LINUX)
                path = Path.Combine(Path.GetDirectoryName(Assembly.GetEntryAssembly().Location), "patch_linux.dat");
            else if (OesisFramework.GetOSType() == OesisFramework.PLATFORM.MAXOS)
                path = Path.Combine(Path.GetDirectoryName(Assembly.GetEntryAssembly().Location), "patch_mac.dat");
            Dictionary<string, object> input = new Dictionary<string, object>()
            {
                { "method", 50302 },
                { "dat_input_source_file", path}
            };
            OesisUtils.CreateJsonIn(ref json_in, input);
            string json_out;
            int rc = this.oesis.Invoke(json_in, out json_out);
            return rc;
        }

        public string FixPath(string path)
        {
            path = path.Replace("\\", "\\\\");
            return path;
        }
    }
}
